<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞书登录授权</title>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="jquery.i18n.properties.js"></script>
    <script type="text/javascript" src="h5-js-sdk-1.4.5.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/vConsole/3.3.0/vconsole.min.js"></script>
</head>

<body>
    <button onclick="clickbutton()">点击</button>
</body>
<script>
    var vConsole = new VConsole();
    console.log(location.href);
    let { code, state, docCreatorLoginName, fdId, isMobile,source} = getUrlkey(location.href)
    if (code) {
        console.log("code, send ajax request");
        console.log(code);
        if(source){
            console.log("qqqqq");
            $.ajax({
                url: "http://10.0.14.48/todolist/agency/v1/fsoaLogin?code=" + code + "&state=" + state,
                type: "get",
                success(res) {
                    console.log(res);
                    if (res.code == 200) {
                        location.href = res.result.redirect_url
                    } else {
                        alert($.i18n.prop('network_err'))
                    }
                },
                error(res) {
                    alert($.i18n.prop('network_err'))
                }
            })
        }else{
            let aUrl = "http://10.25.226.29:8080/fsoa-login.html?code="+code+"&source=0";
            let link = document.createElement('a');
            link.setAttribute('href', aUrl);
            link.setAttribute('target','_blank');
            link.setAttribute('id',"aaa");
            let span = document.createElement('span');
            document.body.appendChild(link);
            link.appendChild(span);
            
            // setTimeout(function(){
            //     window.h5sdk.ready(function() {
            //         console.log("success");
            //         window.h5sdk.biz.navigation.close({
            //             onSuccess:function(result){
            //                 console.log(result);
            //             }
            //         });
            //     });

            //     $("#aaa span").click();
                
            // },200);
        }
    }else{
        let app_id = 'cli_9f6a59d439f35076' //OA待办飞书小程序的appid
        let redirect_url = 'http://10.25.226.29:8080/fsoa-login.html'
        if (docCreatorLoginName == undefined || docCreatorLoginName == null){
          docCreatorLoginName = ''
        }
        if (fdId == undefined || fdId == null){
          fdId = ''
        }
        let state_str = "docCreatorLoginName=" + docCreatorLoginName + "," + "fdId=" + fdId + ",isMobile=" + isMobile
        window.location.href = `https://open.work.sany.com.cn/open-apis/authen/v1/index?redirect_uri=${redirect_url}&app_id=${app_id}&state=${state_str}`
    }
    

    // url参数解析
    function getUrlkey(url) {
        let params = {};
        let urls = url.split("?");
        if(urls.length>1){
            let arr = urls[1].split("&");
            for (let i = 0, l = arr.length; i < l; i++) {
                let a = arr[i].split("=");
                params[a[0]] = a[1];
            }
        }
        return params;
    }
    function clickbutton(){
        window.h5sdk.ready(function() {
                    console.log("success");
                    window.h5sdk.biz.navigation.close({
                        onSuccess:function(result){
                            console.log(result);
                        }
                    });
                });
    }
</script>

</html>
